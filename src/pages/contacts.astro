---
import Layout from '../components/Layout.astro';
import SectionTitle from '../components/SectionTitle.astro';
import { getCollection, getEntry } from 'astro:content';

let settings = null;
try {
  settings = (await getEntry('site', 'settings')).data;
} catch (e) {
  // Settings not found, use defaults
}
const url = Astro.url;
const productSlug = url.searchParams.get('product');
let product = null;

if (productSlug) {
  try {
    product = await getEntry('products', productSlug);
  } catch (e) {
    // Product not found, ignore
  }
}

// Phone numbers - support array or single value
const phones: Array<{ label?: string; number: string }> = Array.isArray(settings?.contactPhones) 
  ? settings.contactPhones 
  : settings?.contactPhone 
    ? [{ label: 'Основен', number: settings.contactPhone }]
    : [];

// Add second phone if available (backward compatible)
if (settings?.contactPhone2 && !Array.isArray(settings?.contactPhones)) {
  phones.push({ label: 'Резервен', number: settings.contactPhone2 });
}

// Debug: Log phones array (remove in production)
// console.log('Phones:', phones);

// Viber contacts - support array or single value
const viberContacts: Array<{ label?: string; number: string }> = Array.isArray(settings?.viberContacts)
  ? settings.viberContacts
  : settings?.viberNumber || settings?.contactPhone
    ? [{ label: 'Основен', number: settings.viberNumber || settings.contactPhone }]
    : [];

// Add second Viber if available (backward compatible)
if (settings?.viberNumber2 && !Array.isArray(settings?.viberContacts)) {
  const secondViber = settings.viberNumber2 || settings?.contactPhone2;
  if (secondViber) {
    viberContacts.push({ label: 'Резервен', number: secondViber });
  }
}

// Debug: Log viber contacts array (remove in production)
// console.log('Viber Contacts:', viberContacts);

// Helper function to create Viber link
const createViberLink = (number: string) => `viber://chat?number=${number.replace(/[^0-9]/g, '')}`;
---

<Layout>
  <title>Контакти - {settings?.siteName || '3D Print Studio'}</title>

  <div class="container mx-auto px-4 py-8">
    <SectionTitle 
      title="Свържи се с нас" 
      subtitle="Имате въпрос или поръчка? Свържете се с нас!" 
    />

    {product && (
      <div class="max-w-3xl mx-auto mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-blue-800 font-semibold mb-2">Запитване за: {product.data.title}</p>
        <p class="text-blue-700 text-sm">{product.data.shortDescription}</p>
      </div>
    )}

    <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-8">
      <!-- Contact Info -->
      <div class="space-y-6">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold mb-4">Контактна информация</h2>
          
          <div class="space-y-6">
            <!-- Phone Numbers -->
            {phones.length > 0 && (
              <div>
                <h3 class="font-semibold mb-3">Телефон</h3>
                <div class="space-y-3">
                  {phones.map((phone, index) => (
                    <div class="flex items-center gap-3">
                      <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                      </svg>
                      <div class="flex-1">
                        <a
                          href={`tel:${phone.number}`}
                          class="text-blue-600 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded font-medium"
                        >
                          {phone.number}
                        </a>
                        {phone.label && (
                          <span class="text-gray-500 text-sm ml-2">({phone.label})</span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <!-- Email -->
            <div>
              <h3 class="font-semibold mb-2">Имейл</h3>
              <a
                href={`mailto:${settings?.contactEmail}`}
                class="text-blue-600 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
              >
                {settings?.contactEmail}
              </a>
            </div>

            <!-- Viber Contacts -->
            {viberContacts.length > 0 && (
              <div>
                <h3 class="font-semibold mb-3">Viber</h3>
                <div class="space-y-3">
                  {viberContacts.map((viber, index) => (
                    <div>
                      <a
                        href={createViberLink(viber.number)}
                        class="inline-flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition w-full md:w-auto justify-center md:justify-start"
                      >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M13.066 0C8.197 0 4.34 3.857 4.34 8.726c0 2.409 1.01 4.574 2.633 6.13L4.276 21.33l6.533-2.636c1.6.87 3.418 1.38 5.257 1.38 4.869 0 8.726-3.857 8.726-8.726C24.592 3.857 20.735 0 15.866 0h-2.8zm.28 19.11c-1.276 0-2.52-.346-3.6-1.002l-.256-.152-2.652 1.07.998-2.58-.17-.28c-1.13-1.87-1.73-4.04-1.73-6.33 0-3.94 3.207-7.147 7.147-7.147h2.8c3.94 0 7.147 3.207 7.147 7.147 0 3.94-3.207 7.147-7.147 7.147-.88 0-1.74-.16-2.547-.456z"/>
                        </svg>
                        Отвори Viber чат{viber.label ? ` (${viber.label})` : ''}
                      </a>
                      <p class="text-gray-600 text-sm mt-1.5">{viber.number}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {settings?.address && (
              <div>
                <h3 class="font-semibold mb-2">Адрес</h3>
                <p class="text-gray-700">{settings.address}</p>
              </div>
            )}
          </div>
        </div>
      </div>

      <!-- Contact Form -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Изпрати запитване</h2>
        <form
          action={`mailto:${settings?.contactEmail}?subject=Запитване от уебсайт${product ? ` - ${product.data.title}` : ''}`}
          method="post"
          enctype="text/plain"
          class="space-y-4"
        >
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
              Име <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
              Имейл <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
              Телефон
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
              Съобщение <span class="text-red-500">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              rows="5"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >{product ? `Запитване за: ${product.data.title}\n\n` : ''}</textarea>
          </div>

          <button
            type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition font-semibold"
          >
            Изпрати запитване
          </button>
        </form>

        <p class="text-sm text-gray-600 mt-4">
          * Формата ще отвори вашия имейл клиент. Можете също да ни се обадите директно или да използвате Viber.
        </p>
      </div>
    </div>
  </div>
</Layout>

