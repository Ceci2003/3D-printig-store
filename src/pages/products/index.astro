---
import Layout from '../../components/Layout.astro';
import SectionTitle from '../../components/SectionTitle.astro';
import ProductCard from '../../components/ProductCard.astro';
import FiltersBar from '../../components/FiltersBar.astro';
import OrderInfo from '../../components/OrderInfo.astro';
import { getCollection, getEntry } from 'astro:content';

let settings: any = null;
try {
  const entry = await getEntry('site', 'settings');
  if (entry) {
    settings = entry.data;
  }
} catch (e) {
  // Settings not found, use defaults
}
const products = await getCollection('products', ({ data }) => data.status === 'active');
let categoriesData: { categories: any[] } = { categories: [] };
try {
  const entry = await getEntry('categories', 'categories');
  if (entry && entry.data) {
    categoriesData = entry.data;
  }
} catch (e) {
  categoriesData = { categories: [] };
}
const seasonalCategory = categoriesData?.categories?.find(cat => cat.id === 'seasonal') || null;
const activeSeasons = (seasonalCategory && 'seasonalConfig' in seasonalCategory && seasonalCategory.seasonalConfig) ? seasonalCategory.seasonalConfig.activeSeasons || [] : [];
const seasonLabels = (seasonalCategory && 'seasonalConfig' in seasonalCategory && seasonalCategory.seasonalConfig && seasonalCategory.seasonalConfig.seasonLabels) ? seasonalCategory.seasonalConfig.seasonLabels : {};

// Filter out seasonal category if no active seasons
const visibleCategories = (categoriesData?.categories || [])
  .filter(cat => {
    if (!cat.visible) return false;
    // Hide seasonal category if no active seasons
    if (cat.id === 'seasonal' && activeSeasons.length === 0) return false;
    return true;
  })
  .sort((a, b) => a.order - b.order);

// Known season IDs for tag matching
const knownSeasonIds = ['christmas', 'valentine', 'easter', 'womensday'];

// Helper function to extract season IDs from product tags
function getProductSeasonIds(tags: string[]): string[] {
  const allSeasonIds = [...activeSeasons, ...knownSeasonIds];
  return tags.filter(tag => allSeasonIds.includes(tag.toLowerCase()));
}

// Get URL params
const urlParams = new URLSearchParams(Astro.url.search);
const urlCategory = urlParams.get('category') || '';
const urlSeasons = urlParams.get('seasons')?.split(',').filter(s => s) || [];
---

<Layout title={`Продукти - ${settings?.siteName || '3D Print Studio'}`}>

  <div class="container mx-auto px-4 py-8">
    <SectionTitle title="Нашите продукти" subtitle="Разгледайте нашата колекция от 3D печатни продукти" />

    <!-- Order Info (Compact) -->
    <OrderInfo />

    <div class="flex flex-col md:flex-row gap-6">
      <!-- Filters Sidebar -->
      <aside class="md:w-64 flex-shrink-0">
        <FiltersBar />
      </aside>

      <!-- Products Grid/List -->
      <div class="flex-grow">
        <!-- View Toggle -->
        <div class="flex justify-between items-center mb-6">
          <p class="text-gray-600">
            Намерени: <span id="product-count">{products.length}</span> продукта
          </p>
          <div class="flex gap-2">
            <button
              id="grid-view-btn"
              type="button"
              class="p-2 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              aria-label="Мрежа изглед"
              aria-pressed="true"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
            </button>
            <button
              id="list-view-btn"
              type="button"
              class="p-2 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              aria-label="Списък изглед"
              aria-pressed="false"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Products Container -->
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" data-view="grid">
          {products.map(product => (
            <div 
              data-product 
              data-category={product.data.categoryId} 
              data-customizable={product.data.isCustomizable} 
              data-title={product.data.title.toLowerCase()} 
              data-description={product.data.shortDescription.toLowerCase()}
              data-tags={product.data.tags?.join(',') || ''}
              data-view="grid"
              data-product-slug={product.slug}
              data-product-title={product.data.title}
              data-product-description={product.data.shortDescription}
              data-product-price={product.data.price || ''}
              data-product-price-from={product.data.priceFrom || ''}
              data-product-image={product.data.images?.[0]?.src || ''}
              data-product-image-alt={product.data.images?.[0]?.alt || ''}
              data-product-is-new={product.data.isNew || false}
              data-product-featured={product.data.featured || false}
              data-product-customizable={product.data.isCustomizable || false}
              data-product-tags={product.data.tags?.join(',') || ''}
              class="product-wrapper"
            >
              <ProductCard product={product} view="grid" seasonLabels={seasonLabels} activeSeasons={activeSeasons} />
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ activeSeasons, seasonLabels, knownSeasonIds: ['christmas', 'valentine', 'easter', 'womensday'] }}>
  const productsContainer = document.getElementById('products-container');
  const gridViewBtn = document.getElementById('grid-view-btn');
  const listViewBtn = document.getElementById('list-view-btn');
  const searchInput = document.getElementById('search');
  const categorySelect = document.getElementById('category');
  const customizableCheck = document.getElementById('customizable');
  const productCount = document.getElementById('product-count');
  const allProducts = Array.from(document.querySelectorAll('[data-product]'));
  
  // URL params
  const urlParams = new URLSearchParams(window.location.search);
  const urlCategory = urlParams.get('category') || '';
  const urlSeasonsParam = urlParams.get('seasons') || '';
  const urlSeasons = urlSeasonsParam ? urlSeasonsParam.split(',').filter(s => s) : [];
  
  // Initialize form from URL
  if (urlCategory && categorySelect) {
    categorySelect.value = urlCategory;
    // Trigger change to show season filter if needed
    categorySelect.dispatchEvent(new Event('change'));
  }
  
  if (urlSeasons.length > 0) {
    urlSeasons.forEach(seasonId => {
      const checkbox = document.getElementById('season-' + seasonId);
      if (checkbox && checkbox instanceof HTMLInputElement) {
        checkbox.checked = true;
      }
    });
  }

  // Load saved view from localStorage or default to grid
  let currentView = localStorage.getItem('product-view') || 'grid';
  if (currentView !== 'grid' && currentView !== 'list') {
    currentView = 'grid';
  }

  // View Toggle
  function setView(view) {
    currentView = view;
    localStorage.setItem('product-view', view);
    
    if (productsContainer) {
      if (view === 'grid') {
        productsContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
        productsContainer.setAttribute('data-view', 'grid');
        gridViewBtn?.classList.add('bg-blue-100', 'text-blue-600');
        gridViewBtn?.setAttribute('aria-pressed', 'true');
        listViewBtn?.classList.remove('bg-blue-100', 'text-blue-600');
        listViewBtn?.setAttribute('aria-pressed', 'false');
      } else {
        productsContainer.className = 'flex flex-col gap-4';
        productsContainer.setAttribute('data-view', 'list');
        listViewBtn?.classList.add('bg-blue-100', 'text-blue-600');
        listViewBtn?.setAttribute('aria-pressed', 'true');
        gridViewBtn?.classList.remove('bg-blue-100', 'text-blue-600');
        gridViewBtn?.setAttribute('aria-pressed', 'false');
      }
    }

    // Update all product wrappers and re-render cards
    allProducts.forEach((productWrapper) => {
      productWrapper.setAttribute('data-view', view);
      
      // Get product data from attributes
      const slug = productWrapper.getAttribute('data-product-slug') || '';
      const title = productWrapper.getAttribute('data-product-title') || '';
      const description = productWrapper.getAttribute('data-product-description') || '';
      const price = productWrapper.getAttribute('data-product-price') || '';
      const priceFrom = productWrapper.getAttribute('data-product-price-from') || '';
      const imageSrc = productWrapper.getAttribute('data-product-image') || '';
      const imageAlt = productWrapper.getAttribute('data-product-image-alt') || '';
      const isNew = productWrapper.getAttribute('data-product-is-new') === 'true';
      const featured = productWrapper.getAttribute('data-product-featured') === 'true';
      const customizable = productWrapper.getAttribute('data-product-customizable') === 'true';
      const productTags = productWrapper.getAttribute('data-product-tags') || '';
      const category = productWrapper.getAttribute('data-category') || '';
      const isSeasonal = category === 'seasonal';
      
      const priceDisplay = price ? `${price} €` : priceFrom ? `от ${priceFrom} €` : 'По запитване';
      
      // Generate season badges HTML from tags
      let seasonBadgesHTML = '';
      if (isSeasonal && productTags) {
        const tagArray = productTags.split(',').map(t => t.trim().toLowerCase());
        const allSeasonIds = [...activeSeasons, ...knownSeasonIds];
        const productSeasonIds = tagArray.filter(tag => allSeasonIds.includes(tag));
        // Use first matching season for badge
        if (productSeasonIds.length > 0) {
          const firstSeason = productSeasonIds[0];
          const label = seasonLabels[firstSeason] || firstSeason;
          seasonBadgesHTML = `<span class="bg-purple-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">${label}</span>`;
        }
      }
      
      // Generate appropriate HTML based on view
      let cardHTML = '';
      
      if (view === 'list') {
        // List view HTML
        cardHTML = `
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 overflow-hidden">
            <div class="flex flex-col md:flex-row md:items-stretch">
              <div class="w-full md:w-56 lg:w-64 h-40 md:h-36 lg:h-40 bg-gray-200 flex-shrink-0 overflow-hidden rounded-t-xl md:rounded-l-xl md:rounded-tr-none">
                ${imageSrc ? `
                  <img src="${imageSrc}" alt="${imageAlt || title}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='/images/missing-photo.png'; this.onerror=null;" />
                ` : `
                  <img src="/images/missing-photo.png" alt="Липсващо изображение" class="w-full h-full object-cover" loading="lazy" />
                `}
              </div>
              <div class="flex-1 flex flex-col p-4 md:p-5">
                <div class="flex items-start justify-between gap-3 mb-2">
                  <h3 class="font-semibold text-lg text-gray-900 flex-1">${title}</h3>
                  <div class="flex gap-1.5 flex-shrink-0 flex-wrap">
                    ${isNew ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Ново</span>' : ''}
                    ${featured ? '<span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Топ</span>' : ''}
                    ${customizable ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Персонализиран</span>' : ''}
                    ${seasonBadgesHTML}
                  </div>
                </div>
                <p class="text-gray-600 text-sm mb-3 line-clamp-2 flex-1">${description}</p>
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-auto pt-3 border-t border-gray-100">
                  <div class="text-xl font-bold text-blue-600">${priceDisplay}</div>
                  <div class="flex gap-2 md:gap-3 flex-shrink-0">
                    <a href="/contacts?product=${slug}" class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition whitespace-nowrap text-center">Поръчай</a>
                    <a href="/products/${slug}" class="w-full md:w-auto px-4 py-2 border border-blue-600 text-blue-600 text-sm font-medium rounded-lg hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition whitespace-nowrap text-center">Детайли</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        // Grid view HTML
        cardHTML = `
          <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow h-full flex flex-col">
            <a href="/products/${slug}" class="block focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg h-full flex flex-col">
              <div class="aspect-square bg-gray-200 relative overflow-hidden">
                ${imageSrc ? `
                  <img src="${imageSrc}" alt="${imageAlt || title}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='/images/missing-photo.png'; this.onerror=null;" />
                ` : `
                  <img src="/images/missing-photo.png" alt="Липсващо изображение" class="w-full h-full object-cover" loading="lazy" />
                `}
                <div class="absolute top-2 right-2 flex gap-1 flex-wrap">
                  ${isNew ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">Ново</span>' : ''}
                  ${featured ? '<span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded">Топ</span>' : ''}
                  ${customizable ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">Персонализиран</span>' : ''}
                  ${seasonBadgesHTML}
                </div>
              </div>
              <div class="p-4 flex flex-col flex-1">
                <div class="flex-1">
                  <h3 class="font-semibold text-lg mb-2 text-gray-900">${title}</h3>
                  <p class="text-gray-600 text-sm mb-3 line-clamp-2">${description}</p>
                  <div class="text-xl font-bold text-blue-600 mb-3">${priceDisplay}</div>
                </div>
                <div class="flex gap-2 mt-auto">
                  <a href="/contacts?product=${slug}" class="flex-1 bg-blue-600 text-white text-center py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">Поръчай</a>
                  <a href="/products/${slug}" class="flex-1 border border-blue-600 text-blue-600 text-center py-2 rounded hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">Детайли</a>
                </div>
              </div>
            </a>
          </div>
        `;
      }
      
      // Replace the card content
      productWrapper.innerHTML = cardHTML;
    });
  }

  gridViewBtn?.addEventListener('click', () => setView('grid'));
  listViewBtn?.addEventListener('click', () => setView('list'));
  
  // Set initial view
  setView(currentView);

  // Update URL with current filter state
  function updateURL() {
    const params = new URLSearchParams();
    const category = categorySelect && categorySelect instanceof HTMLSelectElement ? categorySelect.value : '';
    const search = searchInput && searchInput instanceof HTMLInputElement ? searchInput.value : '';
    const customizable = customizableCheck && customizableCheck instanceof HTMLInputElement ? customizableCheck.checked : false;
    
    // Get selected seasons
    const seasonCheckboxes = document.querySelectorAll('#season-filter-container input[type="checkbox"]:checked');
    const selectedSeasons = Array.from(seasonCheckboxes).map(cb => cb instanceof HTMLInputElement ? cb.value : '').filter(v => v);
    
    if (category) params.set('category', category);
    if (search) params.set('search', search);
    if (customizable) params.set('customizable', 'true');
    if (selectedSeasons.length > 0) params.set('seasons', selectedSeasons.join(','));
    
    const newURL = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
    window.history.replaceState({}, '', newURL);
  }

  // Helper function to extract season IDs from product tags
  function getProductSeasonIds(tags) {
    if (!tags) return [];
    const tagArray = tags.split(',').map(t => t.trim().toLowerCase());
    const allSeasonIds = [...activeSeasons, ...knownSeasonIds];
    return tagArray.filter(tag => allSeasonIds.includes(tag));
  }

  // Filters
  function filterProducts() {
    const searchTerm = searchInput && searchInput instanceof HTMLInputElement ? searchInput.value.toLowerCase() : '';
    const categoryFilter = categorySelect && categorySelect instanceof HTMLSelectElement ? categorySelect.value : '';
    const customizableFilter = customizableCheck && customizableCheck instanceof HTMLInputElement ? customizableCheck.checked : false;
    
    // Get selected seasons
    const seasonCheckboxes = document.querySelectorAll('#season-filter-container input[type="checkbox"]:checked');
    const selectedSeasons = Array.from(seasonCheckboxes).map(cb => cb instanceof HTMLInputElement ? cb.value : '').filter(v => v);
    const isSeasonalCategory = categoryFilter === 'seasonal';

    let visibleCount = 0;

    allProducts.forEach((product) => {
      const category = product.getAttribute('data-category') || '';
      const customizable = product.getAttribute('data-customizable') === 'true';
      const title = product.getAttribute('data-title') || '';
      const description = product.getAttribute('data-description') || '';
      const productTags = product.getAttribute('data-tags') || '';
      const productSeasonIds = getProductSeasonIds(productTags);

      const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
      const matchesCategory = !categoryFilter || category === categoryFilter;
      const matchesCustomizable = !customizableFilter || customizable;
      
      // Season filtering logic
      let matchesSeason = true;
      if (isSeasonalCategory && category === 'seasonal') {
        if (selectedSeasons.length === 0) {
          // No selection: show products where tags intersect activeSeasons
          matchesSeason = productSeasonIds.some(season => activeSeasons.includes(season));
        } else {
          // Selection: show products where tags intersect selectedSeasons
          matchesSeason = productSeasonIds.some(season => selectedSeasons.includes(season));
        }
      } else if (isSeasonalCategory && category !== 'seasonal') {
        // If seasonal category is selected but product is not seasonal, hide it
        matchesSeason = false;
      }

      if (matchesSearch && matchesCategory && matchesCustomizable && matchesSeason) {
        if (product instanceof HTMLElement) {
          product.style.display = '';
        }
        visibleCount++;
      } else {
        if (product instanceof HTMLElement) {
          product.style.display = 'none';
        }
      }
    });

    if (productCount) {
      productCount.textContent = String(visibleCount);
    }
    
    // Update URL
    updateURL();
  }

  searchInput?.addEventListener('input', filterProducts);
  categorySelect?.addEventListener('change', filterProducts);
  customizableCheck?.addEventListener('change', filterProducts);
  
  // Season filter checkboxes
  const seasonCheckboxes = document.querySelectorAll('#season-filter-container input[type="checkbox"]');
  seasonCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', filterProducts);
  });
  
  // Clear filters button - also clear URL params
  const resetBtn = document.getElementById('reset-filters');
  if (resetBtn) {
    const originalReset = resetBtn.onclick;
    resetBtn.addEventListener('click', () => {
      window.history.replaceState({}, '', window.location.pathname);
      filterProducts();
    });
  }
  
  // Initial filter on page load
  filterProducts();

</script>


