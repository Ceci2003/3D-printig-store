---
import Layout from '../../components/Layout.astro';
import SectionTitle from '../../components/SectionTitle.astro';
import ProductCard from '../../components/ProductCard.astro';
import FiltersBar from '../../components/FiltersBar.astro';
import OrderInfo from '../../components/OrderInfo.astro';
import { getCollection, getEntry } from 'astro:content';

let settings = null;
try {
  settings = (await getEntry('site', 'settings')).data;
} catch (e) {
  // Settings not found, use defaults
}
const products = await getCollection('products', ({ data }) => data.status === 'active');
let categoriesData = null;
try {
  categoriesData = (await getEntry('categories', 'categories')).data;
} catch (e) {
  categoriesData = { categories: [] };
}
const visibleCategories = categoriesData.categories
  .filter(cat => cat.visible)
  .sort((a, b) => a.order - b.order);
---

<Layout>
  <title>Продукти - {settings?.siteName || '3D Print Studio'}</title>

  <div class="container mx-auto px-4 py-8">
    <SectionTitle title="Нашите продукти" subtitle="Разгледайте нашата колекция от 3D печатни продукти" />

    <!-- Order Info (Compact) -->
    <OrderInfo />

    <div class="flex flex-col md:flex-row gap-6">
      <!-- Filters Sidebar -->
      <aside class="md:w-64 flex-shrink-0">
        <FiltersBar />
      </aside>

      <!-- Products Grid/List -->
      <div class="flex-grow">
        <!-- View Toggle -->
        <div class="flex justify-between items-center mb-6">
          <p class="text-gray-600">
            Намерени: <span id="product-count">{products.length}</span> продукта
          </p>
          <div class="flex gap-2">
            <button
              id="grid-view-btn"
              type="button"
              class="p-2 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              aria-label="Мрежа изглед"
              aria-pressed="true"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
            </button>
            <button
              id="list-view-btn"
              type="button"
              class="p-2 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
              aria-label="Списък изглед"
              aria-pressed="false"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Products Container -->
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" data-view="grid">
          {products.map(product => (
            <div 
              data-product 
              data-category={product.data.categoryId} 
              data-customizable={product.data.isCustomizable} 
              data-title={product.data.title.toLowerCase()} 
              data-description={product.data.shortDescription.toLowerCase()}
              data-view="grid"
              data-product-slug={product.slug}
              data-product-title={product.data.title}
              data-product-description={product.data.shortDescription}
              data-product-price={product.data.price || ''}
              data-product-price-from={product.data.priceFrom || ''}
              data-product-image={product.data.images?.[0]?.src || ''}
              data-product-image-alt={product.data.images?.[0]?.alt || ''}
              data-product-is-new={product.data.isNew || false}
              data-product-featured={product.data.featured || false}
              data-product-customizable={product.data.isCustomizable || false}
              class="product-wrapper"
            >
              <ProductCard product={product} view="grid" />
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const productsContainer = document.getElementById('products-container');
  const gridViewBtn = document.getElementById('grid-view-btn');
  const listViewBtn = document.getElementById('list-view-btn');
  const searchInput = document.getElementById('search');
  const categorySelect = document.getElementById('category');
  const customizableCheck = document.getElementById('customizable');
  const productCount = document.getElementById('product-count');
  const allProducts = Array.from(document.querySelectorAll('[data-product]'));

  // Load saved view from localStorage or default to grid
  let currentView = (localStorage.getItem('product-view') || 'grid') as 'grid' | 'list';

  // View Toggle
  function setView(view: 'grid' | 'list') {
    currentView = view;
    localStorage.setItem('product-view', view);
    
    if (productsContainer) {
      if (view === 'grid') {
        productsContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
        productsContainer.setAttribute('data-view', 'grid');
        gridViewBtn?.classList.add('bg-blue-100', 'text-blue-600');
        gridViewBtn?.setAttribute('aria-pressed', 'true');
        listViewBtn?.classList.remove('bg-blue-100', 'text-blue-600');
        listViewBtn?.setAttribute('aria-pressed', 'false');
      } else {
        productsContainer.className = 'flex flex-col gap-4';
        productsContainer.setAttribute('data-view', 'list');
        listViewBtn?.classList.add('bg-blue-100', 'text-blue-600');
        listViewBtn?.setAttribute('aria-pressed', 'true');
        gridViewBtn?.classList.remove('bg-blue-100', 'text-blue-600');
        gridViewBtn?.setAttribute('aria-pressed', 'false');
      }
    }

    // Update all product wrappers and re-render cards
    allProducts.forEach((productWrapper) => {
      productWrapper.setAttribute('data-view', view);
      
      // Get product data from attributes
      const slug = productWrapper.getAttribute('data-product-slug') || '';
      const title = productWrapper.getAttribute('data-product-title') || '';
      const description = productWrapper.getAttribute('data-product-description') || '';
      const price = productWrapper.getAttribute('data-product-price') || '';
      const priceFrom = productWrapper.getAttribute('data-product-price-from') || '';
      const imageSrc = productWrapper.getAttribute('data-product-image') || '';
      const imageAlt = productWrapper.getAttribute('data-product-image-alt') || '';
      const isNew = productWrapper.getAttribute('data-product-is-new') === 'true';
      const featured = productWrapper.getAttribute('data-product-featured') === 'true';
      const customizable = productWrapper.getAttribute('data-product-customizable') === 'true';
      
      const priceDisplay = price ? `${price} лв.` : priceFrom ? `от ${priceFrom} лв.` : 'По запитване';
      
      // Generate appropriate HTML based on view
      let cardHTML = '';
      
      if (view === 'list') {
        // List view HTML
        cardHTML = `
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 overflow-hidden">
            <div class="flex flex-col md:flex-row md:items-stretch">
              <div class="w-full md:w-56 lg:w-64 h-40 md:h-36 lg:h-40 bg-gray-200 flex-shrink-0 overflow-hidden rounded-t-xl md:rounded-l-xl md:rounded-tr-none">
                ${imageSrc ? `
                  <img src="${imageSrc}" alt="${imageAlt || title}" class="w-full h-full object-cover" loading="lazy" />
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                `}
              </div>
              <div class="flex-1 flex flex-col p-4 md:p-5">
                <div class="flex items-start justify-between gap-3 mb-2">
                  <h3 class="font-semibold text-lg text-gray-900 flex-1">${title}</h3>
                  <div class="flex gap-1.5 flex-shrink-0 flex-wrap">
                    ${isNew ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Ново</span>' : ''}
                    ${featured ? '<span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Топ</span>' : ''}
                    ${customizable ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Персонализиран</span>' : ''}
                  </div>
                </div>
                <p class="text-gray-600 text-sm mb-3 line-clamp-2 flex-1">${description}</p>
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-auto pt-3 border-t border-gray-100">
                  <div class="text-xl font-bold text-blue-600">${priceDisplay}</div>
                  <div class="flex gap-2 md:gap-3 flex-shrink-0">
                    <a href="/contacts?product=${slug}" class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition whitespace-nowrap text-center">Поръчай</a>
                    <a href="/products/${slug}" class="w-full md:w-auto px-4 py-2 border border-blue-600 text-blue-600 text-sm font-medium rounded-lg hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition whitespace-nowrap text-center">Детайли</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        // Grid view HTML
        cardHTML = `
          <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow h-full flex flex-col">
            <a href="/products/${slug}" class="block focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg h-full flex flex-col">
              <div class="aspect-square bg-gray-200 relative overflow-hidden">
                ${imageSrc ? `
                  <img src="${imageSrc}" alt="${imageAlt || title}" class="w-full h-full object-cover" loading="lazy" />
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-gray-400">
                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                `}
                <div class="absolute top-2 right-2 flex gap-1">
                  ${isNew ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">Ново</span>' : ''}
                  ${featured ? '<span class="bg-yellow-500 text-white text-xs px-2 py-1 rounded">Топ</span>' : ''}
                  ${customizable ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">Персонализиран</span>' : ''}
                </div>
              </div>
              <div class="p-4 flex flex-col flex-1">
                <div class="flex-1">
                  <h3 class="font-semibold text-lg mb-2 text-gray-900">${title}</h3>
                  <p class="text-gray-600 text-sm mb-3 line-clamp-2">${description}</p>
                  <div class="text-xl font-bold text-blue-600 mb-3">${priceDisplay}</div>
                </div>
                <div class="flex gap-2 mt-auto">
                  <a href="/contacts?product=${slug}" class="flex-1 bg-blue-600 text-white text-center py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">Поръчай</a>
                  <a href="/products/${slug}" class="flex-1 border border-blue-600 text-blue-600 text-center py-2 rounded hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">Детайли</a>
                </div>
              </div>
            </a>
          </div>
        `;
      }
      
      // Replace the card content
      productWrapper.innerHTML = cardHTML;
    });
  }

  gridViewBtn?.addEventListener('click', () => setView('grid'));
  listViewBtn?.addEventListener('click', () => setView('list'));
  
  // Set initial view
  setView(currentView);

  // Filters
  function filterProducts() {
    const searchTerm = (searchInput as HTMLInputElement)?.value.toLowerCase() || '';
    const categoryFilter = (categorySelect as HTMLSelectElement)?.value || '';
    const customizableFilter = (customizableCheck as HTMLInputElement)?.checked || false;

    let visibleCount = 0;

    allProducts.forEach((product) => {
      const category = product.getAttribute('data-category') || '';
      const customizable = product.getAttribute('data-customizable') === 'true';
      const title = product.getAttribute('data-title') || '';
      const description = product.getAttribute('data-description') || '';

      const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
      const matchesCategory = !categoryFilter || category === categoryFilter;
      const matchesCustomizable = !customizableFilter || customizable;

      if (matchesSearch && matchesCategory && matchesCustomizable) {
        (product as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (product as HTMLElement).style.display = 'none';
      }
    });

    if (productCount) {
      productCount.textContent = String(visibleCount);
    }
  }

  searchInput?.addEventListener('input', filterProducts);
  categorySelect?.addEventListener('change', filterProducts);
  customizableCheck?.addEventListener('change', filterProducts);

</script>


